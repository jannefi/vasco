name: VASCO step smoke tests

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    name: Step smoke (matrix)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        step:
          - { id: 0, name: "Step 0 — Inputs & Tiling", from: 0, to: 0 }
          - { id: 1, name: "Step 1 — Image Download (DSS1‑red)", from: 1, to: 1 }
          - { id: 2, name: "Step 2 — Preprocess & Bright‑Star Masks", from: 2, to: 2 }
          - { id: 3, name: "Step 3 — SExtractor (Pass 1)", from: 3, to: 3 }
          - { id: 4, name: "Step 4 — PSFEx Model", from: 4, to: 4 }
          - { id: 5, name: "Step 5 — SExtractor (Pass 2, PSF‑aware)", from: 5, to: 5 }
          - { id: 6, name: "Step 6 — External Catalog Fetch (USNO‑B I/284; PS1 optional)", from: 6, to: 6 }
          - { id: 7, name: "Step 7 — STILTS Cross‑Match", from: 7, to: 7 }
          - { id: 8, name: "Step 8 — Filtering & Validation", from: 8, to: 8 }
          - { id: 9, name: "Step 9 — Summaries & Dashboard", from: 9, to: 9 }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Detect CLI entrypoint
        id: detect
        shell: bash
        run: |
          if [[ -f scripts/cli/one2pass.py ]]; then
            echo "cli=scripts/cli/one2pass.py" >> $GITHUB_OUTPUT
          elif [[ -f scripts/cli/run_random.py ]]; then
            echo "cli=scripts/cli/run_random.py" >> $GITHUB_OUTPUT
          else
            echo "cli=NONE" >> $GITHUB_OUTPUT
          fi

      - name: Soft-skip when CLI missing
        if: steps.detect.outputs.cli == 'NONE'
        shell: bash
        run: |
          echo "::notice::CLI entrypoint missing; soft-skipping ${{ matrix.step.name }}"

      - name: Run smoke ${{ matrix.step.name }}
        if: steps.detect.outputs.cli != 'NONE'
        shell: bash
        continue-on-error: true
        env:
          CLI: ${{ steps.detect.outputs.cli }}
          RA: "150.0"
          DEC: "20.0"
        run: |
          set +e
          mkdir -p data/runs
          if [[ "$CLI" == "scripts/cli/one2pass.py" ]]; then
            python "$CLI" --ra "$RA" --dec "$DEC" --from-step "${{ matrix.step.from }}" --to-step "${{ matrix.step.to }}"
          else
            # Fallback: run_random.py may not support per-step; try a minimal run
            python "$CLI" --ra "$RA" --dec "$DEC" --limit 1
          fi
          echo "::notice::Smoke attempted for ${{ matrix.step.name }} (non-blocking)"

      - name: Best-effort artifact hints (never failing)
        shell: bash
        continue-on-error: true
        run: |
          case "${{ matrix.step.id }}" in
            0) test -f data/tiles/*/tiles.csv || echo "::warning::tiles.csv missing (Step 0 hint)" ;;
            1) test -d data/downloads        || echo "::warning::downloads missing (Step 1 hint)" ;;
            2) test -d data/masks            || echo "::warning::masks missing (Step 2 hint)" ;;
            3) test -d data/catalogs/p1      || echo "::warning::p1 catalogs missing (Step 3 hint)" ;;
            4) test -d data/psf              || echo "::warning::psf missing (Step 4 hint)" ;;
            5) test -d data/catalogs/p2      || echo "::warning::p2 catalogs missing (Step 5 hint)" ;;
            6) test -d data/ext/usnob        || echo "::warning::usnob missing (Step 6 hint)" ;;
            7) test -d data/xmatch           || echo "::warning::xmatch missing (Step 7 hint)" ;;
            8) test -d data/filter           || echo "::warning::filter missing (Step 8 hint)" ;;
            9) test -d data/summaries        || echo "::warning::summaries missing (Step 9 hint)" ;;
          esac
