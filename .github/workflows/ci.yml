
name: CI

on:
  push:
    branches: [ main, feature/** ]
    paths:
      - '**/*.py'
      - 'tools/**/*.sh'
      - 'mnras-repro.yaml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.py'
      - 'tools/**/*.sh'
      - 'mnras-repro.yaml'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

jobs:
  py-compile:
    name: Python syntax check (py_compile)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [ '3.10' ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Compile all Python files
        shell: bash
        run: |
          set -euo pipefail
          files=$(git ls-files '*.py' || true)
          if [ -z "$files" ]; then
            echo "No Python files found"; exit 0; fi
          python - <<'PY'
          import sys, subprocess, py_compile
          files = subprocess.check_output(['git','ls-files','*.py'], text=True).splitlines()
          errors = []
          for f in files:
              try:
                  py_compile.compile(f, doraise=True)
                  print(f"OK  {f}")
              except Exception as e:
                  print(f"ERR {f}: {e}")
                  errors.append((f, str(e)))
          if errors:
              print("Summary of failures:")
              for f, e in errors:
                  print(f" - {f}: {e}")
              sys.exit(1)
          PY

  shell-scripts:
    name: Shell scripts lint (shellcheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Run shellcheck (if any scripts)
        shell: bash
        run: |
          shopt -s nullglob
          files=(tools/*.sh tools/**/*.sh)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No shell scripts to check."
            exit 0
          fi
          shellcheck "${files[@]}"
